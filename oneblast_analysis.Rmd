---
title: "DoD Military Community and Family Policy Military OneSource eNewsletter"
author: "Paul Testa and Jake Bowers"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
    html_document:
        toc: TRUE
---

```{r init,echo=F}
library(knitr)
opts_chunk$set(eval=T,echo=F,results="hide",message=F,warning=F,cache=T)

```

\tableofcontents

# Setup

- Download "wrkdat.csv" and "subscribersPlus.csv" onto local machine in the data subdirectory
- Load files and libaries

```{r setup}
wrkdat<-read.csv("data/wrkdat.csv",as.is=TRUE)
subscribers<-read.csv("data/subscribersPlus.csv",as.is=TRUE)

```

The outcome is whether or not a member of the experimental pool subscribed to the newsletter. We currently assume that all members of the experimental pool who have a 0 for subscribed did not subscribe under a different name and email address. We return to scrutinize the effect of this assumption later.

```{r}
# Use this as the primary DV
table(wrkdat$subscribed,exclude=c())
```

Because the experiment was randomized by batch, and because of trouble matching subscribers uniquely to the experimental pool, we analyze the data by a collapsed version of the 82 batch indicators that we call `batchday`. Nearly all batches were sent 2 per day and the subscriber data only has day of subscription, not hour or minute.

Do we have enough information to reject the claim that there are no differences between the treatments? We use the generalized Cochran-Mantel-Haensel test to address this question. We are using the coin library because it allows for easy assessment of this test without large sample assumptions.

```{r}
library(coin)

wrkdat$batchday2F<-factor(wrkdat$batchday2)
wrkdat$treatmentF<-factor(wrkdat$treatment)
wrkdat$subscribedF<-factor(wrkdat$subscribed)

## Checking for missing data
##bigtab<-with(wrkdat,table(batchday2F,treatmentF,subscribed,exclude=c()))
bigtab<-with(wrkdat,table(treatmentF,subscribed,batchday2F))

cmh1approx<-cmh_test(subscribedF~treatmentF|batchday2F,data=wrkdat,distribution=approximate(B=1000))
cmh1<-cmh_test(subscribedF~treatmentF|batchday2F,data=wrkdat)
cmh2 <- mantelhaen.test(bigtab)

cmh1
```

There is a lot of evidence against the idea that all six emails had the same effect. Here are the differences in proportions subscribing after weighting by size of batch.

see <https://htmlpreview.github.io/?https://github.com/acoppock/Green-Lab-SOP/blob/master/Green_Lab_SOP.html#taking-block-randomization-into-account-in-ses-and-cis>


```{r}
## Probably junk, harmonic weighted differences of means here.
options(width=132,digits=6,scipen=8)
wrkdat$sBatchAve<-ave(wrkdat$subscribed,wrkdat$batchday2F)
lm1<-lm(I(subscribed-sBatchAve)~treatment,data=wrkdat)
coef(lm1)


```





OLDER STUFF BELOW
```{r}
# Reorder as factor for prop tests
wrkdat$subscribe<-ifelse(wrkdat$subscribe01==1,"Subscribed","Not Subscribed")
wrkdat$subscribe<-factor(wrkdat$subscribe,levels=c("Subscribed","Not Subscribed"))
```


The primary dataset in this analysis contains `r dim(data)[1]` study participants, each randomly assigned to receive one of six treatment emails

- `r dim(data)[1]` participants
- `r dim(subscribers)[1]` subscribers
- `r sum(wrkdat$emailhash%in%subscribers$emailhash)` participants in list of subscribers
    - `r dim(subscribers)[1]-sum(wrkdat$emailhash%in%subscribers$emailhash)` emails in list of subcriber different from emails in list of participants


# Outcome


The outcome is whether participants subscribed to the newsletter. It was constructed in the following way: First subscribers were identified by matching their unique email address in the design dataset to a list of  `r dim(subscribers)[1]` subscribers' emails.  Additional subscribers were identified by then matching on first and last names in each dataset. Some names appear multiple times in each dataset. These cases, where a single subscriber name is matched to multiple participants with the same name, are then recoded as NA for the primary analysis. We assess the sensitivity of our results to different categorizations of the roughly 140 people who we excluded from the analysis because of unclear treatment assignment below. In total, using email address and names, we are able to match `r sum(wrkdat$subscribe01==1)` participants to the list of subscribers (i.e. `r round( sum(wrkdat$subscribe01==1)/dim(subscribers)[1]*100,1)`\% of subscribers).





# Randomization Assessment

```{r ra,results="asis"}
tab0<-data.frame(Treatement=names(table(wrkdat$treatment)),
                                  N=matrix(table(wrkdat$treatment)))
knitr::kable(tab0)
table(wrkdat$treatment,wrkdat$Batch,exclude=c())
```


- Treatment appears to have been administred in 82 batches of 6000 participants with the exception of batch 82, which was sent  `r table(wrkdat$Batch)[82]` recipients.


# Comparisons Across Newsletters

```{r pwcomp}
# Holm
pw_props_holm<-with(data,pairwise.prop.test(table(treatment,subscribe01)[,c(2,1)],
                                       p.adjust.method = "holm"
                                       ))
# No correction
pw_props_none<-with(data,pairwise.prop.test(table(treatment,subscribe01)[,c(2,1)],
                                       p.adjust.method = "none"
                                       ))
```


The tables below show:

- The raw counts and proportions of people subscribing by treatment status
- The p-values from pairwise comparisons of these proportions using the Holm (1979) correction for multiple comparisons, as well as wihtout any adjustments.

Overall subscription rates are low (~1 percent). The differences between conditions are also small (about one to two tenths of a percent). Using the Holm correction for multiple comparisons, `r sum(pw_props_holm$p.value<0.05,na.rm=T)` of the 15 comparisons are statistically significant (p<0.05, 8 p<0.06, and  `r sum(pw_props_none$p.value<0.05,na.rm=T)` without adjusting for multiple comparisons).

## Proportion Subscribing  by Treatment Status
```{r tab1,results="asis"}
# Proportion Subscribing by Treatment
tab1<-rbind(table(wrkdat$treatment),
            table(wrkdat$subscribe,wrkdat$treatment),
            paste("**",round(unlist(lapply(split(wrkdat$subscribe01,f=wrkdat$treatment),mean)),4),"**",sep=""))
rownames(tab1)<-c("N","Subscribed","Not Subscribed","**Proportion Subscribing**")
kable(tab1,caption="Proprortion Subscribing by Treatment Status")
```

## P-Values for Pairwise Comparison of Proportions (Holm Correction)

```{r tab2,results="asis"}



tab_pw_props_holm<-matrix(sprintf("%.4f",round(pw_props_holm$p.value,5)),5,5)
colnames(tab_pw_props_holm)<-colnames(pw_props_holm$p.value)
rownames(tab_pw_props_holm)<-rownames(pw_props_holm$p.value)
tab_pw_props_holm[tab_pw_props_holm=="NA"] <- ""

kable(tab_pw_props_holm,
      caption="Pairwise comparisons using Pairwise comparison of proportions (Holm Correction)")

```


## P-Values for Pairwise Comparison of Proportions (No Correction for Multiple Comparisons)

```{r tab3,results="asis"}

tab_pw_props_none<-matrix(sprintf("%.4f",round(pw_props_none$p.value,5)),5,5)
colnames(tab_pw_props_none)<-colnames(pw_props_none$p.value)
rownames(tab_pw_props_none)<-rownames(pw_props_none$p.value)
tab_pw_props_none[tab_pw_props_none=="NA"] <- ""

kable(tab_pw_props_none,
      caption="Pairwise comparisons using Pairwise comparison of proportions (Holm Correction)")


```

# Comparisons Across Treatment Type


```{r tablemaker}
# Function to make tables
table.maker<-function(x){
    # Difference of Proportions
     test<-stats::prop.test(table(x,wrkdat$subscribe01)[,c(2,1)])
     diff<- sprintf("%.4f",round(test$estimate[1]-test$estimate[2],5))
     pval<- sprintf("%.4f",round(test$p.value,5))
    # MH Test using Batch
    mhtest<-mantelhaen.test(table(x,wrkdat$subscribe,wrkdat$Batch))
    mhtest.pval<-sprintf("%.3f",round(mhtest$p.value,3))
    mhtest.stat<-sprintf("%.3f",round(mhtest$statistic,3))
    tab<-rbind(table(x),
            table(wrkdat$subscribe,x),
            paste("**",round(unlist(lapply(split(wrkdat$subscribe01,f=x),mean)),4),"**",sep=""),c(" "," "),
            c("*Statistic*","*p-value*"),
            c(diff,pval),
            c( mhtest.stat,mhtest.pval))
    rownames(tab)<-c("**Sample**","Subscribed","Not Subscribed","Proportion Subscribing","___","**Test**","Difference in Proportions"," CMH $\\chi^2$ Test")
    colnames(tab)<-paste("**",colnames(tab),"**",sep="")
    return(tab)


}
```

This section makes the following comparisons:

- A,C,E versus B,D,F (a test of opt-in versus enhanced active).
- A,B,C,D versus E,F (a test of Block of 10 present versus active)
- A,B versus C,D (a test of list versus quiz format)

For each comparison, the tables present:

- The raw counts and proportions of people subscribing by treatment status
- A test of the difference in proportions
- A test of the difference using the Cochran-Mantel-Haenszel Chi-Squared Test for Count Data treating each batch as separate strata.

Ovearll rates of subscription are higher:

- In treatment conditions with enhanced active choice (B,D,F) rather than a single opt-in (A,C,E)
- In treamtn conditions where the block 10 is absent (E,F) rather than present (A,B,C,D)
- In treament conditions that present information in a list format (A,B) rather than a quiz format (C,D).

# A,C,E versus B,D,F (a test of opt-in versus enhanced active).

```{r tabbdf, results="asis"}
# A,C,E versus B,D,F (a test of opt-in versus enhanced active).

wrkdat$treat_bdf_01<-as.numeric(grepl("B|D|F",wrkdat$treatment))
wrkdat$treat_bdf<-ifelse(grepl("B|D|F",wrkdat$treatment),"Enhanced Active","Opt-In")
tab_bdf<-table.maker(wrkdat$treat_bdf)
kable(tab_bdf,caption="Enhanced Active versus Single Opt-In")

```

# A,B,C,D versus E,F (a test of Block of 10 present versus active)

```{r tababcd,results="asis"}
# A,B,C,D versus E,F (a test of Block of 10 present versus active)

wrkdat$treat_abcd_01<-as.numeric(grepl("A|B|C|D",wrkdat$treatment))
wrkdat$treat_abcd<-ifelse(grepl("A|B|C|D",wrkdat$treatment),"Present","Absent")
wrkdat$treat_abcd<-factor(wrkdat$treat_abcd,levels=c("Present","Absent"))
tab_abcd<-table.maker(wrkdat$treat_abcd)
kable(tab_abcd,caption="Block of 10 Present or Absent")


```

# A,B versus C,D (a test of list versus quiz format)

```{r tabab,results="asis"}
# A,B versus C,D (a test of list versus quiz format)

wrkdat$treat_ab_01<-as.numeric(grepl("A|B",wrkdat$treatment))
wrkdat$treat_ab_01[!grepl("A|B|C|D",wrkdat$treatment)]<-NA
wrkdat$treat_ab<-ifelse(wrkdat$treat_ab_01==1,"List","Quiz")

tab_ab<-table.maker(wrkdat$treat_ab)
kable(tab_ab)

```

# Instances of Multiple Names

## Design Data

```{r, results="asis"}
kable(tab_names_data)
```

## Subscriber Data

```{r, results="asis"}
kable(tab_names_sub)
```


# Code

```{r, echo=T,eval=F}
<<init>>
<<setup>>
<<clean>>
<<ra>>
<<pwcomp>>
<<tab1>>
<<tab2>>
<<tab3>>
<<tablemaker>>
<<tabbdf>>
<<tababcd>>
<<tabab>>
```

