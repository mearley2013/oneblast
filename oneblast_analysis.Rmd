---
title: "DoD Military Community and Family Policy Military OneSource eNewsletter"
author: "Paul Testa"
date: "July 8, 2016"
output: 
    html_document:
        toc: TRUE
---

```{r init,echo=F}
library(knitr)
opts_chunk$set(eval=T,echo=F,results="hide",message=F,warning=F,cache=T)

```

\tableofcontents

# Setup

- Download "designdata.csv" and "subscriptiondata.csv" onto local machine
- Load files and libaries

```{r setup}
#setwd("~/Documents/sbst/oneblast/")
data<-read.csv("data/designdata.csv")
subscribers<-read.csv("data/subscriptiondata.csv")
```

# Check and Clean Data

- `r dim(data)[1]` participants
- `r dim(subscribers)[1]` subscribers
- `r sum(data$id%in%subscribers$id)` participants in list of subscribers
    - `r dim(subscribers)[1]-sum(data$id%in%subscribers$id)` emails in list of subcriber different from emails in list of participants

```{r clean}

dim(data) # 491879 observations
# Make sure observations are unique:
length(unique(data$id))==dim(data)[1]

dim(subscribers) # 7759 subscriptions

dim(data) # 491879 observations
dim(subscribers) # 7759 subscriptions
sum(data$id%in%subscribers$id) # 5563 subscribers in initial email list

# Rename Treatment indicator
names(data)[3]<-"treatment"

# Additional variables
summary(data$Order.Within.Condition)
table(data$Condition.Order.Within.Batch)

# Create DV
data$subscribe01<-ifelse(data$id%in%subscribers$id,1,0)
# Reorder as factor for prop tests
data$subscribe<-ifelse(data$subscribe01==1,"Subscribed","Not Subscribed")
data$subscribe<-factor(data$subscribe,levels=c("Subscribed","Not Subscribed"))
```

# Randomization Assessment

```{r ra,results="asis"}
tab0<-data.frame(Treatement=names(table(data$treatment)),
                                  N=matrix(table(data$treatment)))
kable(tab0)
```

- Treatment appears to have been administred in 82 batches of 6000 participants with the exception of batch 82, which was sent  `r table(data$Batch)[82]` recipients. 


# Comparisons Across Newsletters

The tables below show:

- The raw counts and proportions of people subscribing by treatment status
- The p-values from pairwise comparisons of these proportions with and wihtout adjustments for mutliple compairsons

Overall subscription rates are low (~1 percent). The differences between conditions are also small (about one to two tenths of a percent). Using the Bonferroni correction for multiple comparisons, seven of the 15 comparisons are statistically significant (p<0.05). 

## Proportion Subscribing  by Treatment Status
```{r tab1,results="asis"}
# Proportion Subscribing by Treatment
tab1<-rbind(table(data$treatment),
            table(data$subscribe,data$treatment),
            paste("**",round(unlist(lapply(split(data$subscribe01,f=data$treatment),mean)),4),"**",sep=""))
rownames(tab1)<-c("N","Subscribed","Not Subscribed","**Proportion Subscribing**")
kable(tab1,caption="Proprortion Subscribing by Treatment Status")
```

## P-Values for Pairwise Comparison of Proportions (Bonferroni Correction)

```{r tab2,results="asis"}

pw_props_bf<-with(data,pairwise.prop.test(table(treatment,subscribe01)[,c(2,1)],
                                       p.adjust.method = "bonferroni"
                                       ))
pw_props_bf$p.value<-round(pw_props_bf$p.value,3)
pw_props_bf$p.value[is.na(pw_props_bf$p.value)]<-""
kable(pw_props_bf$p.value,
      caption="Pairwise comparisons using Pairwise comparison of proportions (Bonferroni Correction)")

```


## P-Values for Pairwise Comparison of Proportions (No Correction for Multiple Comparisons)

```{r tab3,results="asis"}
pw_props_none<-with(data,pairwise.prop.test(table(treatment,subscribe01),
                                       p.adjust.method = "none"
                                       ))
pw_props_none$p.value<-round(pw_props_none$p.value,3)
pw_props_none$p.value[is.na(pw_props_none$p.value)]<-""
kable(pw_props_none$p.value,
      caption="Pairwise comparisons using Pairwise comparison of proportions (Bonferroni Correction)")

```

# Comparisons Across Treatment Type


```{r tablemaker}
# Function to make tables 
table.maker<-function(x){
    # Difference of Proportions
     test<-prop.test(table(x,data$subscribe01)[,c(2,1)])
     diff<-round(test$estimate[1]-test$estimate[2],5)
     pval<-round(test$p.value,3)
    # MH Test using Batch
    mhtest<-mantelhaen.test(table(x,data$subscribe,data$Batch))
    mhtest.pval<-round(mhtest$p.value,3)
    mhtest.stat<-round(mhtest$statistic,3)
    tab<-rbind(table(x),
            table(data$subscribe,x),
            paste("**",round(unlist(lapply(split(data$subscribe01,f=x),mean)),4),"**",sep=""),c(" "," "),
            c("*Statistic*","*p-value*"),
            c(diff,pval),
            c( mhtest.stat,mhtest.pval))
    rownames(tab)<-c("**Sample**","Subscribed","Not Subscribed","Proportion Subscribing","___","**Test**","Difference in Proportions"," CMH $\\chi^2$ Test")
    colnames(tab)<-paste("**",colnames(tab),"**",sep="")
    return(tab)
    
    
}
```

This section makes the following comparisons:

- A,C,E versus B,D,F (a test of opt-in versus enhanced active).
- A,B,C,D versus E,F (a test of Block of 10 present versus active)
- A,B versus C,D (a test of list versus quiz format)

For each comparison, the tables present:

- The raw counts and proportions of people subscribing by treatment status
- A test of the difference in proportions
- A test of the difference using the Cochran-Mantel-Haenszel Chi-Squared Test for Count Data treating each batch as separate strata.

Ovearll rates of subscription are higher:

- In treatment conditions with enhanced active choice (B,D,F) rather than a single opt-in (A,C,E)
- In treamtn conditions where the block 10 is absent (E,F) rather than present (A,B,C,D)
- In treament conditions that present information in a list format (A,B) rather than a quiz format (C,D).

# A,C,E versus B,D,F (a test of opt-in versus enhanced active).

```{r tabbdf, results="asis"}
# A,C,E versus B,D,F (a test of opt-in versus enhanced active).

data$treat_bdf_01<-as.numeric(grepl("B|D|F",data$treatment))
data$treat_bdf<-ifelse(grepl("B|D|F",data$treatment),"Enhanced Active","Opt-In")
tab_bdf<-table.maker(data$treat_bdf)
kable(tab_bdf,caption="Enhanced Active versus Single Opt-In")
```

# A,B,C,D versus E,F (a test of Block of 10 present versus active)

```{r tababcd,results="asis"}
# A,B,C,D versus E,F (a test of Block of 10 present versus active)

data$treat_abcd_01<-as.numeric(grepl("A|B|C|D",data$treatment))
data$treat_abcd<-ifelse(grepl("A|B|C|D",data$treatment),"Present","Absent")
data$treat_abcd<-factor(data$treat_abcd,levels=c("Present","Absent"))
tab_abcd<-table.maker(data$treat_abcd)
kable(tab_abcd,caption="Block of 10 Present or Absent")

```

# A,B versus C,D (a test of list versus quiz format)

```{r tabab,results="asis"}
# A,B versus C,D (a test of list versus quiz format)

data$treat_ab_01<-as.numeric(grepl("A|B",data$treatment))
data$treat_ab_01[!grepl("A|B|C|D",data$treatment)]<-NA
data$treat_ab<-ifelse(data$treat_ab_01==1,"List","Quiz")


tab_ab<-table.maker(data$treat_ab)
kable(tab_ab)

```


# Code

```{r, echo=T,eval=F}
<<init>>
<<setup>>
<<clean>>
<<ra>>
<<tab1>>
<<tab2>>
<<tab3>>
<<tablemaker>>
<<tabbdf>>
<<tababcd>>
<<tabab>>
```

